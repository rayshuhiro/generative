<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MediaPipe Hand Landmarks (DIV + Index)</title>
<style>
  html, body { margin:0; height:100%; overflow:hidden; background:#000; }
  #wrap { position: fixed; inset: 0; }
  video {
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit: cover;
    transform: scaleX(-1);
  }
  #layer {
    position:absolute; inset:0;
    pointer-events:none;
  }
  .point {
    position:absolute;
    width:18px; height:18px;
    margin-left:-9px; margin-top:-9px;
    border-radius:50%;
    color:#000;
    font: bold 11px/18px system-ui;
    text-align:center;
  }
  .right { background: rgba(0, 220, 255, 0.9); }
  .left  { background: rgba(255, 60, 60, 0.9); }

  /* ★ 人差し指用の動的要素 */
  .cursor {
    position:absolute;
    width:40px;
    height:40px;
    margin-left:-20px;
    margin-top:-20px;
    border-radius:50%;
    opacity:0.7;
    pointer-events:none;
  }

  #msg {
    position: fixed; top:12px; left:12px;
    padding:8px 12px; border-radius:6px;
    background: rgba(0,0,0,.5); color:#fff; font-size:14px;
  }
</style>
</head>
<body>

<div id="wrap">
  <video id="cam" autoplay playsinline></video>
  <div id="layer"></div>
</div>
<div id="msg">初期化中…</div>

<script type="module">
import { HandLandmarker, FilesetResolver } from
  "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

const video = document.getElementById("cam");
const layer = document.getElementById("layer");
const msg = document.getElementById("msg");

let handLandmarker;
let lastVideoTime = -1;

// ランドマーク表示用
const points = [[], []];

// ★ 人差し指用要素（左右）
const cursors = [];

for (let h = 0; h < 2; h++) {

  // 21点
  for (let i = 0; i < 21; i++) {
    const d = document.createElement("div");
    d.className = "point";
    d.textContent = i;
    d.style.display = "none";
    layer.appendChild(d);
    points[h].push(d);
  }

  // ★ 人差し指用カーソル
  const c = document.createElement("div");
  c.className = "cursor";
  c.style.display = "none";
  layer.appendChild(c);
  cursors.push(c);
}

async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" }, audio: false
  });
  video.srcObject = stream;
  await new Promise(r => video.onloadedmetadata = r);
  await video.play().catch(()=>{});
}

async function initMediaPipe(){
  const vision = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
  );
  handLandmarker = await HandLandmarker.createFromOptions(vision, {
    baseOptions: {
      modelAssetPath:
        "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task"
    },
    runningMode: "VIDEO",
    numHands: 2
  });
}

function loop(){
  const now = performance.now();

  if (video.currentTime !== lastVideoTime) {
    const result = handLandmarker.detectForVideo(video, now);
    lastVideoTime = video.currentTime;

    const hands = result?.landmarks || [];
    const handedness = result?.handedness || [];

    if (hands.length) {
      msg.textContent = "両手検出中";
      const rect = layer.getBoundingClientRect();

      hands.forEach((hand, hIndex) => {
        const label = handedness[hIndex]?.[0]?.categoryName;
        const cls = label === "Right" ? "left" : "right";

        // 21点表示
        hand.forEach((p, i) => {
          const x = (1 - p.x) * rect.width;
          const y = p.y * rect.height;
          const el = points[hIndex][i];
          el.classList.remove("left", "right");
          el.classList.add(cls);
          el.style.transform = `translate(${x}px, ${y}px)`;
          el.style.display = "block";
        });

        // ★ 人差し指（8番）
        const p8 = hand[8];
        const cx = (1 - p8.x) * rect.width;
        const cy = p8.y * rect.height;

        const cursor = cursors[hIndex];
        cursor.style.background =
          cls === "left"
            ? "rgba(255,60,60,0.6)"
            : "rgba(0,220,255,0.6)";
        cursor.style.transform = `translate(${cx}px, ${cy}px)`;
        cursor.style.display = "block";
      });

      for (let i = hands.length; i < 2; i++) {
        points[i].forEach(p => p.style.display = "none");
        cursors[i].style.display = "none";
      }

    } else {
      msg.textContent = "手が見つかりません";
      points.flat().forEach(p => p.style.display = "none");
      cursors.forEach(c => c.style.display = "none");
    }
  }
  requestAnimationFrame(loop);
}

(async function main(){
  try {
    await startCamera();
    await initMediaPipe();
    msg.textContent = "手を映してください";
    requestAnimationFrame(loop);
  } catch (e) {
    console.error(e);
    msg.textContent = "起動できません（HTTPS/権限を確認）";
  }
})();
</script>

</body>
</html>

